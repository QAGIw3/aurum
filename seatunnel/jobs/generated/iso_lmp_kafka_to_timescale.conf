# ISO LMP topics â†’ TimescaleDB (JDBC)
#
# Required environment variables:
#   KAFKA_BOOTSTRAP_SERVERS  - Kafka brokers
#   SCHEMA_REGISTRY_URL      - Schema Registry endpoint
#   TIMESCALE_JDBC_URL       - JDBC URL for TimescaleDB (e.g. jdbc:postgresql://timescale:5432/timeseries)
#   TIMESCALE_USER           - Timescale username
#   TIMESCALE_PASSWORD       - Timescale password
#
# Optional environment variables:
#   ISO_LMP_TOPIC_PATTERN    - Regex pattern for topics (default aurum\.iso\..*\.lmp\.v1)
#   ISO_LMP_TABLE            - Timescale table (default iso_lmp_timeseries)
#   ISO_LMP_SAVE_MODE        - Save mode (append)

env {
  job.mode = "STREAMING"
  checkpoint.interval = 60000
}

source {
  Kafka {
    bootstrap.servers = "localhost:29092"
    pattern = "aurum\.iso\..*\.lmp\.v1"
    format = "avro"
    start_mode = "latest"
    avro {
      schema.registry.url = "http://localhost:8081"
    }
    result_table_name = "lmp_raw"
  }
}

transform {
  Sql {
    source_table_name = "lmp_raw"
    result_table_name = "lmp_enriched"
    query = """
      SELECT
        record_hash,
        NULL AS tenant_id,
        iso_code,
        market,
        (DATE '1970-01-01' + delivery_date * INTERVAL '1 day') AS delivery_date,
        TO_TIMESTAMP(interval_start / 1000000.0) AS interval_start,
        CASE
          WHEN interval_end IS NOT NULL THEN TO_TIMESTAMP(interval_end / 1000000.0)
          ELSE NULL
        END AS interval_end,
        interval_minutes,
        location_id,
        location_name,
        location_type,
        price_total,
        price_energy,
        price_congestion,
        price_loss,
        currency,
        uom,
        settlement_point,
        source_run_id,
        CASE
          WHEN metadata IS NULL THEN NULL
          ELSE CAST(metadata AS STRING)
        END AS metadata,
        TO_TIMESTAMP(ingest_ts / 1000000.0) AS ingest_ts
      FROM lmp_raw
    """
  }
}

sink {
  Jdbc {
    driver = "org.postgresql.Driver"
    url = "jdbc:postgresql://localhost:5433/timeseries"
    user = "timescale"
    password = "timescale"
    table = "iso_lmp_timeseries"
    primary_keys = ["record_hash"]
    save_mode = "append"
    connection_check_timeout_sec = 30
  }
}
